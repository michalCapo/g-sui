#!/bin/bash

# Deploy script for g-sui
# Automatically increments version (0.100 -> 0.101 -> 0.102, etc.)

set -e  # Exit on error

# Get the latest tag matching v0.* pattern
LATEST_TAG=$(git tag -l "v0.*" | sort -V | tail -1)

if [ -z "$LATEST_TAG" ]; then
    # No tags exist, start at v0.100
    NEW_VERSION="v0.100"
    echo "No existing tags found. Starting at version $NEW_VERSION"
else
    # Extract version number from latest tag (e.g., v0.100 -> 100)
    VERSION_NUM=$(echo "$LATEST_TAG" | sed 's/v0\.//')
    
    # Increment version number
    NEW_VERSION_NUM=$((VERSION_NUM + 1))
    NEW_VERSION="v0.$NEW_VERSION_NUM"
    
    echo "Latest version: $LATEST_TAG"
    echo "New version: $NEW_VERSION"
fi

# Check if working tree is clean
if ! git diff-index --quiet HEAD --; then
    echo "Error: Working tree has uncommitted changes. Please commit or stash them first."
    exit 1
fi

# Check if we're on the correct branch (optional check)
CURRENT_BRANCH=$(git branch --show-current)
echo "Current branch: $CURRENT_BRANCH"

# Create annotated tag
echo "Creating tag $NEW_VERSION..."
git tag -a "$NEW_VERSION" -m "Release version $NEW_VERSION"

# Push tag to origin
echo "Pushing tag $NEW_VERSION to origin..."
git push origin "$NEW_VERSION"

echo ""
echo "âœ“ Successfully deployed version $NEW_VERSION"
echo "  Tag created and pushed to origin"
echo ""
echo "Next steps:"
echo "  - Create a GitHub release: https://github.com/michalCapo/go-srui/releases/new"
echo "  - Select tag: $NEW_VERSION"
